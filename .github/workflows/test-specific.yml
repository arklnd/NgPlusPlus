name: Run a specific test

on:
  workflow_dispatch:
    inputs:
      test_pattern:
        description: 'Test pattern to run'
        required: true
        default: 'should invoke dumbResolverHandler with HYUI8 Angular dependencies'
        type: string
      max_attempts:
        description: 'Maximum attempts for dependency resolution'
        required: false
        default: '200'
        type: string
      openai_model:
        description: 'OpenAI model to use (GPT-4.1, GPT-4o, GPT-5-mini and grok-code are 0x models, haiku 0.33x model)'
        required: false
        default: 'copilot-gpt-4'
        type: choice
        options:
          - 'copilot-gpt-4.1'
          - 'copilot-gpt-5-mini'
          - 'copilot-gpt-5'
          - 'copilot-gpt-3.5-turbo'
          - 'copilot-gpt-4o-mini'
          - 'copilot-gpt-4'
          - 'copilot-gpt-4-turbo'
          - 'copilot-gpt-4o'
          - 'copilot-o3-mini'
          - 'copilot-grok-code'
          - 'copilot-gpt-5-codex'
          - 'copilot-claude-3.5-sonnet'
          - 'copilot-claude-sonnet-4'
          - 'copilot-claude-sonnet-4.5'
          - 'copilot-claude-haiku-4.5'
          - 'copilot-gemini-2.5-pro'
          - 'copilot-gpt-5-auto'

jobs:
  TestCase:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
 
    - name: Install dependencies
      run: npm i --verbose

    - name: Build project
      run: npm run build

    - name: Run test
      if: success()
      run: npx mocha -- --grep "${{ github.event.inputs.test_pattern }}"
      env:
        MAX_ATTEMPTS: ${{ github.event.inputs.max_attempts }}
        OPENAI_MODEL: ${{ github.event.inputs.openai_model }}

    - name: Display test results
      if: always()
      run: echo "Test execution completed with pattern - ${{ github.event.inputs.test_pattern }}"

    - name: Prepare artifact name
      if: always()
      id: artifact_name
      run: |
        node -e "
        const testPattern = process.argv[1];
        const runNumber = process.argv[2];
        const cleanName = testPattern.replace(/\s/g, '_');
        const artifactName = cleanName + '__logs-' + runNumber;
        require('fs').appendFileSync(process.env.GITHUB_OUTPUT, 'name=' + artifactName + '\n');
        console.log('Generated artifact name:', artifactName);
        " '${{ github.event.inputs.test_pattern }}' '${{ github.run_number }}'

    - name: Upload logs as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.artifact_name.outputs.name }}
        path: |
          logs/
          src/logs/
          src/utils/logs/
          test/assets/git-git/
          test/assets/**
          test/assets/.*
          package-cache.db
        retention-days: 30