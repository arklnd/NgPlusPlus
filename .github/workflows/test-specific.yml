name: Run a specific test

on:
  workflow_dispatch:
    inputs:
      test_pattern:
        description: 'Test pattern to run'
        required: true
        default: 'should invoke dumbResolverHandler with HYUI8 Angular dependencies'
        type: string

jobs:
  TestCase:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
 
    - name: Install dependencies
      run: npm i --verbose

    - name: Build project
      run: npm run build

    - name: Run test
      if: success()
      run: npx mocha -- --grep "${{ github.event.inputs.test_pattern }}"

    - name: Display test results
      if: always()
      run: echo "Test execution completed with pattern - ${{ github.event.inputs.test_pattern }}"

    - name: Prepare artifact name
      if: always()
      id: artifact_name
      run: |
        node -e "
        const testPattern = process.argv[1];
        const runNumber = process.argv[2];
        const cleanName = testPattern.replace(/\s/g, '_');
        const artifactName = cleanName + '__logs-' + runNumber;
        require('fs').appendFileSync(process.env.GITHUB_OUTPUT, 'name=' + artifactName + '\n');
        console.log('Generated artifact name:', artifactName);
        " '${{ github.event.inputs.test_pattern }}' '${{ github.run_number }}'

    - name: Upload logs as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.artifact_name.outputs.name }}
        path: |
          logs/
          src/logs/
          src/utils/logs/
          test/assets/
          package-cache.db
        retention-days: 30