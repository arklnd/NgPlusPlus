name: Run a specific test

on:
  workflow_dispatch:
    inputs:
      test_pattern:
        description: 'Test pattern to run'
        required: true
        default: 'should invoke dumbResolverHandler with HYUI8 Angular dependencies'
        type: string
      max_attempts:
        description: 'Maximum attempts for dependency resolution'
        required: false
        default: '200'
        type: string
      openai_base_url:
        description: 'Base URL for OpenAI API (for custom endpoints)'
        required: false
        default: 'http://localhost:3000/v1/'
        type: string
      openai_model:
        description: 'OpenAI model to use (GPT-4.1, GPT-4o, GPT-5-mini and grok-code are 0x models, haiku 0.33x model)'
        required: false
        default: 'copilot-grok-code'
        type: choice
        options:
          - 'copilot-gpt-4.1'
          - 'copilot-gpt-5-mini'
          - 'copilot-gpt-5'
          - 'copilot-gpt-3.5-turbo'
          - 'copilot-gpt-4o-mini'
          - 'copilot-gpt-4'
          - 'copilot-gpt-4-turbo'
          - 'copilot-gpt-4o'
          - 'copilot-o3-mini'
          - 'copilot-grok-code'
          - 'copilot-gpt-5-codex'
          - 'copilot-claude-3.5-sonnet'
          - 'copilot-claude-sonnet-4'
          - 'copilot-claude-sonnet-4.5'
          - 'copilot-claude-haiku-4.5'
          - 'copilot-gemini-2.5-pro'
          - 'copilot-gpt-5-auto'

jobs:
  TestCase:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
 
    - name: Install dependencies
      run: npm i --verbose

    - name: Build project
      run: npm run build

    - name: Run test
      if: success()
      continue-on-error: true
      id: test_run
      run: npx mocha -- --grep "${{ github.event.inputs.test_pattern }}"
      timeout-minutes: 180
      env:
        MAX_ATTEMPTS: ${{ github.event.inputs.max_attempts }}
        OPENAI_MODEL: ${{ github.event.inputs.openai_model }}
        OPENAI_BASE_URL: ${{ github.event.inputs.openai_base_url }}
    
    - name: Check test outcome
      if: always()
      run: |
        node -e "
        const outcome = process.argv[1];
        if (outcome === 'cancelled') {
          console.log('⚠️ Test was cancelled - artifacts may be incomplete');
          process.exit(0);
        } else if (outcome === 'failure') {
          console.log('❌ Test failed - check artifacts for details');
          process.exit(0);
        } else {
          console.log('✅ Test completed successfully');
        }
        " '${{ steps.test_run.outcome }}'


    - name: Prepare artifact name
      if: always()
      id: artifact_name
      run: npx tsx .github/scripts/prepare-artifact-name.ts "${{ github.event.inputs.test_pattern }}" "${{ github.run_number }}" "${{ github.event.inputs.max_attempts }}" "${{ github.run_attempt }}"

    - name: Debug - Show artifact name
      if: always()
      run: echo "Artifact name is ${{ steps.artifact_name.outputs.name }}"

    - name: Debug - List files before upload
      if: always()
      run: npx tsx .github/scripts/debug-files.ts

    - name: Debug - Show Git logs from test run
      if: always()
      run:
        npx tsx .github/scripts/show-git-logs.ts

    - name: Upload logs as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.artifact_name.outputs.name }}
        path: |
          logs/
          src/logs/
          src/utils/logs/
          test/assets/
          **/*.db
        retention-days: 30
        if-no-files-found: warn
        include-hidden-files: true

    - name: Show cache contents
      if: always()
      run: npx tsx .github/scripts/print-cache.ts