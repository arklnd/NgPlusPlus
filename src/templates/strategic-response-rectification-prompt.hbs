{{#if strategicResponse}}
# ORIGINAL STRATEGIC RESPONSE SUGGESTIONS

{{#each strategicResponse.suggestions}}
- **{{this.name}}**: v{{this.fromVersion}} â†’ v{{this.version}} ({{#if this.isDev}}devDependency{{else}}dependency{{/if}})
  - Reason: {{this.reason}}
{{/each}}

**Original Analysis:** {{strategicResponse.analysis}}

{{/if}}

# DEPENDENCY REQUIREMENTS VALIDATION

{{#if suggestedAndRequiredVersions}}
The following shows for each suggested package upgrade what version constraints are imposed by its dependents:

{{#each suggestedAndRequiredVersions}}
## Package: **{{@key}}** {{#with (lookup ../allPackagesMap @key)}}(rank {{rank}}, tier {{tier}}){{/with}}
- **Originally Suggested Version:** {{this.suggestedVersion}}
{{#if this.requirements}}
- **Must Satisfy These Dependent Requirements:**
{{#each this.requirements}}
  - `{{this.requiredByDependentPack}}` requires: `{{this.requiredVersion}}`
{{/each}}

**CRITICAL VALIDATION:** The suggested version `{{this.suggestedVersion}}` must satisfy ALL the above version constraints. If it does NOT, you MUST find an alternative version from the available versions listed in the conflict analysis below that satisfies all requirements.
{{else}}
- **No dependent requirements found** - package has no known dependents in the current project.
{{/if}}

{{/each}}
{{/if}}

# CONFLICT ANALYSIS & AVAILABLE VERSIONS

{{#if conflictAnalysis}}
The following packages have version conflicts that need resolution:

{{#each conflictAnalysis.conflicts}}
**CONFLICTING PACKAGE:** "{{this.packageName}}" {{#with (lookup ../allPackagesMap this.packageName)}}(rank {{rank}}){{/with}} current version installed v{{this.currentVersion}}
{{#with (lookup ../allPackagesMap this.packageName)}}
Available versions of {{../this.packageName}}: {{#each packagesVersionData}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}
{{/with}}

**DEPENDENTS SATISFIED BY CURRENT VERSION OF "{{this.packageName}}":**
{{#each this.requiredBy}}
{{#if isSatisfied}}
- {{dependent}}@{{dependentVersion}} {{#with (lookup ../../allPackagesMap dependent)}}(rank {{rank}}){{/with}} requires {{{ requiredRange }}} ({{type}})
{{#with (lookup ../../allPackagesMap dependent)}}
Available versions for {{../dependent}}: {{#each packagesVersionData}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}
{{/with}}
{{/if}}
{{/each}}

**DEPENDENTS NOT SATISFIED BY CURRENT VERSION OF "{{this.packageName}}":**
{{#each this.requiredBy}}
{{#unless isSatisfied}}
- {{dependent}}@{{dependentVersion}} {{#with (lookup ../../allPackagesMap dependent)}}(rank {{rank}}){{/with}} requires {{{ requiredRange }}} ({{type}})
{{#with (lookup ../../allPackagesMap dependent)}}
Available versions for {{../dependent}}: {{#each packagesVersionData}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}
{{/with}}
{{/unless}}
{{/each}}
{{/each}}
{{/if}}

# YOUR TASK: RECTIFY THE STRATEGIC RESPONSE

Based on the three sections above:
1. **ORIGINAL STRATEGIC RESPONSE** - initial suggestions that may have conflicts
2. **DEPENDENCY REQUIREMENTS VALIDATION** - showing what version constraints each suggested package must satisfy
3. **CONFLICT ANALYSIS** - showing current conflicts and available versions

You must provide a **RECTIFIED** StrategicResponse that intelligently resolves all conflicts.

## CRITICAL: YOU HAVE FULL FLEXIBILITY
You are NOT limited to the original suggestions. You can:
- **DISCARD** any original suggestion that doesn't make sense
- **MODIFY** versions to better satisfy constraints
- **ADD NEW SUGGESTIONS** for packages not in the original list if they resolve conflicts
- **REMOVE SUGGESTIONS** where the current version is already optimal (no upgrade needed)
- **COMPLETELY REDESIGN** the upgrade strategy based on all available information

**IMPORTANT: Understanding `<NULL>` Versions**
- If the original suggestions contain a package with version `"<NULL>"`, it means the initial analysis could NOT find a suitable version to satisfy the given conflicting situation
- **YOU CAN RECTIFY THIS**: With the additional information provided (dependency requirements, conflict analysis, available versions, and package ranks), you have MORE context to find a solution
- Use your intelligence and the comprehensive data to resolve `<NULL>` cases - often upgrading/downgrading related packages can unlock a solution
- Only keep `<NULL>` as a last resort if truly no solution exists after exhaustive analysis

**Think holistically**: You have comprehensive data about dependents, conflicts, available versions, and package ranks. Use ALL this information to create the BEST possible resolution strategy, not just fix the original suggestions.

## MANDATORY REQUIREMENTS:
1. **Validate ALL suggested versions** against their dependent requirements shown in section 2
2. **Replace any invalid suggestions** with versions that satisfy ALL dependent constraints
3. **Resolve ALL conflicts** shown in section 3 - use creative logical solutions if needed
4. **Prioritize higher-ranked packages** (lower rank number = higher priority) when making trade-offs
5. **Maintain dependency vs devDependency classification** correctly
6. **Select versions from the "Available Versions" lists** provided above
7. **Ensure peer dependency compatibility** - peer dependencies are CRITICAL and must be satisfied
8. **OMIT suggestions where no upgrade is needed** - if current version already satisfies all requirements, don't include it

## INTELLIGENT RESOLUTION STRATEGY:
- **Analyze dependency chains**: Sometimes upgrading a dependent resolves multiple conflicts
- **Consider cascade effects**: Upgrading one package might enable upgrades for others
- **For conflicting packages**: Choose a version that satisfies the MAXIMUM number of dependents
- **If no single version satisfies all**: Prefer satisfying higher-ranked dependents
- **Look for alternative solutions**: Instead of forcing one package version, consider if upgrading/downgrading related packages creates a better overall solution
- **Use the conflict analysis data**: Pay attention to which dependents are satisfied/unsatisfied by current versions
- **Leverage available versions lists**: These show all your options for each package
- **Document your creative reasoning**: Explain why your solution is better than alternatives

## OUTPUT FORMAT:
Respond with JSON matching the StrategicResponse interface:

```json
{
  "suggestions": [
    {
      "name": "package-name",
      "version": "VALIDATED-version-that-satisfies-all-requirements",
      "isDev": true/false,
      "reason": "Detailed explanation: why this version was chosen, which constraints it satisfies, which conflicts it resolves, and why this approach is better than alternatives",
      "fromVersion": "current-version"
    }
  ],
  "analysis": "Comprehensive analysis explaining: (1) what was wrong with original suggestions (if anything), (2) which dependency requirements were validated, (3) how conflicts were resolved, (4) any creative solutions or alternative approaches taken, (5) any trade-offs made with justification based on package ranks and dependency chains, (6) why your rectified strategy is optimal",
  "reasoning": {
    "updateMade": [
      {
        "package": {
          "name": "package-being-upgraded",
          "rank": "COPY_EXACT_RANK_FROM_CONFLICT_ANALYSIS_SECTION_ABOVE"
        },
        "fromVersion": "1.0.0",
        "toVersion": "2.0.0",
        "reasoningComment": "Explain: (1) why this specific version, (2) which dependent requirements it satisfies, (3) how it resolves conflicts, (4) why this choice over alternatives",
        "reason": {
          "name": "higher-ranked-package-or-dependent-causing-need-for-change",
          "rank": "COPY_EXACT_RANK_FROM_CONFLICT_ANALYSIS_SECTION_ABOVE"
        }
      }
    ]
  }
}
```

## CRITICAL REMINDERS:
1. **USE EXACT RANK VALUES** from the conflict analysis sections above - do not make up rank numbers
2. **VALIDATE EACH VERSION** against the "DEPENDENCY REQUIREMENTS VALIDATION" section
3. **CHOOSE ONLY from available versions** listed in "Available Versions" for each package
4. **PEER DEPENDENCIES are non-negotiable** - they MUST be satisfied
5. **ONLY INCLUDE packages that NEED upgrades** - if current version is fine, OMIT the suggestion entirely
6. **BE CREATIVE AND SMART** - you can suggest packages not in the original list if they resolve conflicts better
7. **RECTIFY `<NULL>` VERSIONS** - If original suggestions have `"<NULL>"` versions, it means no suitable version was found initially. Use the additional context (dependents, conflicts, ranks) to find creative solutions. Often upgrading related packages can resolve these cases.
8. **Respond ONLY with the JSON** - no additional text before or after the JSON block
9. **CRITICAL: For version field** - If no suitable version is found after exhaustive analysis and creative problem-solving, use the STRING `"<NULL>"` (with quotes as a string value), NOT the JSON `null` keyword. The version field must ALWAYS be a string type in JSON. However, strive to find creative solutions before resorting to `<NULL>` - you have more information than the original analyzer.

 