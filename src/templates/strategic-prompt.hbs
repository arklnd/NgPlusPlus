STRATEGIC DEPENDENCY RESOLUTION - ATTEMPT {{attempt}}/{{maxAttempts}}

TARGET UPGRADES USER WANT TO DO: {{targetPackages}}

⚠️ **CRITICAL: USE EXACT RANKS FROM CONFLICT ANALYSIS BELOW**
When generating reasoning records, you MUST use the exact rank values provided in the CONFLICT ANALYSIS section. Do NOT generate, estimate, or modify rank values.

REASONING:
{{#if reasoningRecording}}
{{#if reasoningRecording.updateMade}}
{{#each reasoningRecording.updateMade}}
- PREVIOUS UPDATE: {{package.name}} (rank {{package.rank}}) upgraded from {{fromVersion}} to {{toVersion}} to resolve conflict with higher rank valued package {{reason.name}} (rank {{reason.rank}})
{{/each}}
{{else}}
- No previous reasoning recorded.
{{/if}}
{{else}}
- No previous reasoning recorded.
{{/if}}

CONFLICT ANALYSIS:
⚠️ **IMPORTANT: The rank values below are the AUTHORITATIVE source for package rankings. Use these EXACT values in your new reasoning records.**
{{#if analysis}}
**CONFLICTING PACKAGE:** "{{analysis.conflictingPackage}}" (rank {{analysis.rank}}) current version installed v{{analysis.conflictingPackageCurrentVersion}}
  Available versions of {{analysis.conflictingPackage}}: {{#each analysis.conflictingPackageAvailableVersions}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}

**PACKAGES SATISFIED BY CURRENT VERSION OF "{{analysis.conflictingPackage}}":**
{{#each analysis.satisfyingPackages}}
- {{packageName}}@{{packageVersion}} (rank {{rank}}) requires {{{ requiredVersionRange }}}
  Available versions for {{packageName}}: {{#each availableVersions}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}
{{/each}}

**PACKAGES NOT SATISFIED:**
{{#each analysis.notSatisfying}}
- {{packageName}}@{{packageVersion}} (rank {{rank}}) requires {{{ requiredVersionRange }}}
  Available versions for {{packageName}}: {{#each availableVersions}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}
{{/each}}
{{else}}
- No conflict analysis available.
{{/if}}

STRATEGIC INSTRUCTIONS:
1. **Conflict Resolution Priority**: When resolving dependency conflicts, prioritize upgrading non-satisfying packages with the LOWEST rank first. Higher-ranked packages (core frameworks, official libraries) should be kept stable, while lower-ranked packages (utilities, experimental) should be upgraded to resolve conflicts.

2. **Resolution Logic**:
   - Here the goal is to achieve TARGET UPGRADES USER WANT TO DO.
   - Identify all non-satisfying packages from the conflict analysis, upgrade the lowest-ranked packages first to satisfy the higher-ranked dependencies.
   - **Use the EXACT rank values provided in the CONFLICT ANALYSIS section above for decision making**
   - Higher rank packages should influence upgrade decisions for lower rank packages.
   - Higher the rank value, more priority it has in the upgrade decision-making process.
   - Lower rank packages should be upgraded first to resolve conflicts with higher rank packages.
   - Choose versions from the available versions lists ONLY that best resolve the conflicts while adhering to the ranking strategy.
   - **When recording reasoning, use the EXACT rank values from the conflict analysis - do not modify or estimate ranks**
   - If no suitable version is found for a low-rank package, set upgraded version to <NULL>.
   - e.g. {
      "name": "package-name",
      "version": "<NULL>",
      "isDev": true/false,
      "reason": "no suitable version found to resolve conflict with higher-ranked package",
      "fromVersion": "current-version"
    }

3. **Available Versions Strategy**: 
   - Use the `availableVersions` arrays from the conflict analysis to make informed upgrade decisions
   - For conflicting packages, choose from `conflictingPackageAvailableVersions` to find compatible versions
   - For satisfying/non-satisfying packages, use their `availableVersions` to select appropriate versions
   - Prefer stable/LTS versions when available, avoid pre-release versions unless necessary

4. **Reasoning Recording**: 
   - Consider the previous reasoning record to understand what upgrades have already been made and why
   - For each new upgrade suggestion, provide reasoning that explains:
     * Which package is being upgraded (with its rank FROM THE CONFLICT ANALYSIS ABOVE)
     * Which higher-ranked package(s) it's conflicting with that necessitated this upgrade
     * Why this specific version was chosen to resolve the conflict (from available versions)
   - Never upgrade higher rank packages to satisfy lower rank ones.
   - Build upon previous reasoning to create a comprehensive upgrade strategy
   - **CRITICAL: Use EXACT rank values from the CONFLICT ANALYSIS section above. Do NOT generate new rank values.**

5. **Rank Usage Instructions**:
   - **ALWAYS use the exact rank values provided in the CONFLICT ANALYSIS section above**
   - For packages in "PACKAGES SATISFIED BY CURRENT VERSION", use their listed rank values
   - For packages in "PACKAGES NOT SATISFIED (CAUSING CONFLICT)", use their listed rank values
   - For the conflicting package itself, use the rank from the conflict analysis if available
   - **NEVER invent or estimate rank values - only use what's explicitly provided in the conflict analysis**
   - If a rank is not provided in the conflict analysis, use 999999 as a fallback
   - **VALIDATION: Before finalizing your response, verify that all rank values in your reasoning section exactly match the ranks shown in the CONFLICT ANALYSIS above**

Respond with JSON containing strategic upgrade suggestions:
{
  "suggestions": [
    {
      "name": "package-name",
      "version": "suggested-version",
      "isDev": true/false,
      "reason": "strategic rationale for this upgrade",
      "fromVersion": "current-version"
    }
  ],
  "analysis": "strategic analysis of the conflict and resolution approach",
  "reasoning": {
    "updateMade": [
      {
        "package": {
          "name": "package-being-upgraded",
          "rank": "COPY_EXACT_RANK_FROM_CONFLICT_ANALYSIS_SECTION_ABOVE"
        },
        "fromVersion": "1.0.0",
        "toVersion": "2.0.0",
        "reason": {
          "name": "higher-ranked-package-causing-conflict",
          "rank": "COPY_EXACT_RANK_FROM_CONFLICT_ANALYSIS_SECTION_ABOVE"
        }
      }
    ]
  }
}
